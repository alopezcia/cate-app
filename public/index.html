<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro Catequesis App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="./style.css" rel="stylesheet"/>
    <script type="module">
      import { v4 as uuidv4 } from 'https://jspm.dev/uuid';
      localStorage.setItem("uuid", uuidv4());
    </script>
  </head>

  <body>

   <div class="container">
    <form class="needs-validation" novalidate id="main-form">

    <!-- Anagramas -->
      <div class="row g-3">
        <div class="col-lg-1">
            <img src="./iglesia_parroquial_sant_vicent_ferrer.png" width="100px">
        </div>
  
        <div class="col-10 text-center">
            <div class="row" >
              <h3>FICHA DE INSCRIPCIÓN CATEQUESIS DE LA COMUNIDAD 2022/23</h3>
            </div>
  
            <div class="row py-1" >
              <div class="col-2"><h5>Parroquia</h5></div>
              <div class="col-8">
                <!-- <input class="col-12" type="text" width="100%"> -->
                <select class="selectpicker col-12" name="parroquia">
                  <option>San Vicente Ferrer</option>
                  <option>La Inmaculada</option>
                </select>
              </div> 
            </div>

            <div class="row p-1">
              <div class="col-2"><h5>Nivel</h5></div>
              <div class="col-8">
                <!-- <input class="col-12" type="text" width="100%"> -->
                <select class="selectpicker col-12" name="nivel">
                  <option>Despertar Religioso: 2º PRIMARIA</option>
                  <option>Pre-Comunión:        3º PRIMARIA</option>
                  <option>1a COMUNIÓN:         4º PRIMARIA</option>
                  <option>Grupos ITIO: 5º y 6º PRIMARIA, 1º y 2º ESO</option>
                  <option>Confirmación: 2º ESO, 1º BACH.</option>
                </select>
              </div> 
              <div class="col-2"><small>(Seleccionar)</small></div> 
            </div>
        </div>
  
        <div class="col-lg-1">
            <img src="./parroquia_inmaculada_concepcion.png" width="100px">
        </div>
      </div>

      <!-- Formulario -->
      <div>
        <div aria-labelledby="exampleModalLongTitle" class="modal fade" id="bookingmodal" role="dialog" tabindex="-1" style="display: none;" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <form>
                  <input type="button" id="reset" value="Borrar" class="btn btn-danger">
                </form>
                <!-- <span id="coords"><small>xxx yyy</small></span> -->
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="guide">
                  <div class="row item">
                    <div class="col-md-12 order-md-2">
                      <h2 class="item-heading"><span class="text-muted">Firma del progenitor/a</span></h2>
                      <canvas id="canvas"/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <!-- <span id="coords-calc"><small>xxx yyy</small></span> -->
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Firmar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- <form class="needs-validation" novalidate id="main-form"> -->
          <!-- Nombre y apellidos del niño -->
          <div class="row g-3">
            <div class="col-sm-6">
              <label for="apellidos" class="form-label">Del niño/a apellidos</label>
              <input type="text" class="form-control" id="apellidos" name="apellidos" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor para los apellidos es obligatorio
              </div>
            </div>
            <div class="col-sm-6">
              <label for="nombre" class="form-label">y nombre</label>
              <input type="text" class="form-control" id="nombre" name="nombre" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor para el nombre es obligatorio
              </div>
            </div>
          </div>

          <!-- Parroquia y fecha nacimiento -->
          <div class="row g-3">
            <div class="col-sm-8">
              <label for="bautizo" class="form-label">Parroquia donde se bautizó</label>
              <select class="selectpicker col-12" name="bautizo">
                <option>San Vicente Ferrer</option>
                <option>Inmaculada Concepción</option>
                <option>Santa Isabel de Hungría</option>
                <option>Otra</option>
                <option>No está bautizado</option>
              </select>
              <!-- <input type="text" class="form-control" id="parroquia-bautizo" name="parroquia-bautizo" placeholder="" value="" required> -->
              <!-- <div class="invalid-feedback">
              El valor para la parroquia donde se bautizo es obligatorio
              </div> -->
            </div>
            <div class="col-sm-4">
              <label for="fechaNacimiento" class="form-label">Fecha de nacimiento (dd/mm/aaaa)</label>
              <input type="text" class="form-control" id="fechaNacimiento" name="fechaNacimiento" placeholder="" value="" required>
              <div class="invalid-feedback">
              La fecha de nacimiento es obligatoria
              </div>
            </div>
          </div>

          <!-- Colegio - Curso -->
          <div class="row g-3">
            <div class="col-sm-8">
              <label for="colegio" class="form-label">Colegio actual</label>
              <input type="text" class="form-control" id="colegio" name="colegio" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor para el colegio actual es obligatorio
              </div>
            </div>
            <div class="col-sm-4">
              <label for="curso" class="form-label">Curso escolar</label>
              <select class="selectpicker col-12" name="curso">
                <option>4º PRIMARIA</option>
                <option>6º PRIMARIA</option>
                <option>1º ESO</option>
                <option>2º ESO</option>
                <option>3º ESO</option>
                <option>4º ESO</option>
                <option>1º BACH.</option>
                <option>2º BACH.</option>
              </select>

              <!-- <input type="text" class="form-control" id="curso-escolar" name="curso-escolar" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor para el curso escolar es obligatorio
              </div> -->
            </div>
          </div>

          <!-- Nombre y apellidos del padre -->
          <div class="row g-3">
            <div class="col-sm-12">
              <label for="profesor" class="form-label">Nombre profesor religión</label>
              <input type="text" class="form-control" id="profesor" name="profesor" placeholder="">
            </div>
          </div>

          
          <hr>
          <!-- Nombre y apellidos del padre -->
          <div class="row g-3">
            <div class="col-sm-6">
              <label for="apellidosPadre" class="form-label">Del padre apellidos</label>
              <input type="text" class="form-control" id="apellidosPadre" id="apellidosPadre" name="apellidosPadre" placeholder="">
            </div>

            <div class="col-sm-6">
              <label for="nombrePadre" class="form-label">y nombre</label>
              <input type="text" class="form-control" id="nombrePadre" name="nombrePadre" placeholder="" value="">
            </div>
          </div>

          <!-- Dni y tlfno del padre -->
          <div class="row g-3">
            <div class="col-sm-6">
              <label for="dniPadre" class="form-label">DNI del padre</label>
              <input type="text" class="form-control" id="dniPadre" name="dniPadre" placeholder="" value="">
            </div>
            <div class="col-sm-6">
              <label for="telefonoPadre" class="form-label">Teléfono del padre</label>
              <input type="text" class="form-control" id="telefonoPadre" name="telefonoPadre" placeholder="" value="">
            </div>
          </div>

          <!-- Firma Padre -->
          <div class="row p-2">
            <!-- Firma Padre -->
            <div class="col-sm-12">
              <div class="col-12 text-center">
                <img id="firmadoPadre" width="200" height="100"/>
                <button type="button" class="btn btn-success" 
                      data-target="#bookingmodal" 
                      data-toggle="modal" data-bs-p="Padre">Firmar</button>
                <button type="button" id="certificadoPadre" class="redondeado" onclick="firmaConCertificado('Padre')" data-bs-p="Padre">
                  <img src="./certificate-icon-10.png" alt="buttonpng" width="30" height="30"/>
                </button>
              </div>
            </div>
          </div>
          <hr class="my-4">

          <!-- Nombre y apellidos de la madre -->
          <div class="row g-3">
            <div class="col-sm-6">
              <label for="apellidosMadre" class="form-label">De la madre apellidos</label>
              <input type="text" class="form-control" id="apellidosMadre" name="apellidosMadre" placeholder="" value="">
            </div>
            <div class="col-sm-6">
              <label for="nombreMadre" class="form-label">y nombre</label>
              <input type="text" class="form-control" id="nombreMadre" name="nombreMadre" placeholder="" value="">
            </div>
          </div>

          <!-- Dni y tlfn de la madre -->
          <div class="row g-3">
            <div class="col-sm-6">
              <label for="dniMadre" class="form-label">DNI de la madre</label>
              <input type="text" class="form-control" id="dniMadre" name="dniMadre" placeholder="" value="">
            </div>
            <div class="col-sm-6">
              <label for="telefonoMadre" class="form-label">Teléfono de la madre</label>
              <input type="text" class="form-control" id="telefonoMadre" name="telefonoMadre" placeholder="" value="">
            </div>
          </div>

          <!-- Firma Madre-->
          <div class="row p-2">
            <div class="col-sm-12">
              <div class="col-12 text-center">
                <img id="firmadoMadre" width="200" height="100"/>
                <button type="button" class="btn btn-success" 
                      data-target="#bookingmodal" 
                      data-toggle="modal" data-bs-p="Madre">Firmar</button>
                <button type="button" id="certificadoMadre" class="redondeado" onclick="firmaConCertificado('Madre')" data-bs-p="Madre">
                  <img src="./certificate-icon-10.png" alt="buttonpng" width="30" height="30"/>
                </button>
              </div>
            </div>
          </div>
          <hr class="my-4">

          <!-- Dirección y codpostal -->
          <div class="row g-3">
            <div class="col-sm-9">
              <label for="direccion" class="form-label">Dirección</label>
              <input type="text" class="form-control" id="direccion" name="direccion" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor para la dirección es obligatorio
              </div>
            </div>
  
            <div class="col-sm-3">
              <label for="codpost" class="form-label">C.P.</label>
              <input type="text" class="form-control" id="codpost" name="codpost" placeholder="" value="" required>
              <div class="invalid-feedback">
                El valor del código postal es obligatorio
              </div>
            </div>
          </div>
  
          <!-- e-mail -->
          <div class="row g-3">
            <div class="col-12">
              <label for="email" class="form-label">Email <span class="text-muted">(Optional)</span></label>
              <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com">
              <div class="invalid-feedback">
                El valor del email de contacto es obligatorio
              </div>
            </div>
          </div>

          <!-- Alergias -->
          <div class="row g-3">
            <div class="col-12">
              <label for="alergias" class="form-label">Alergias, circunstancias epeciales en la familia, dificultades de aprendizaje, etc. <span class="text-muted">(Optional)</span></label>
              <textarea class="form-control" id="alergias" name="alergias" rows="3"></textarea>
            </div>
          </div>

          <!-- Comentarios -->
          <div class="row g-3">
            <div class="col-12">
              <label for="comentarios" class="form-label">Comentarios <span class="text-muted">(Optional)</span></label>
              <textarea class="form-control" id="comentarios" name="comentarios" rows="3"></textarea>
            </div>
          </div>

          <h5>PROTECCIÓN DE DATOS I:</h5>
          <div class="col-12">
            <div class="row">
              <div class="col-10">
                <p>IMAGEN DIGITAL: Consiento la publicación de la imagen en las Redes Sociales y WEB de las Parroquias como del Obispado de Orihuela-Alicante.</p>
              </div>
              <div class="col-2">
                <div class="form-check form-check-inline">
                  <input id="imagenDigitalSi" name="imagenDigital" type="radio" class="form-check-input" checked required>
                  <label class="form-check-label" for="imagenDigitalSi">SI</label>
                </div>
                <div class="form-check form-check-inline">
                  <input id="imagenDigitalNo" name="imagenDigital" type="radio" class="form-check-input" required>
                  <label class="form-check-label" for="imagenDigitalNo">NO</label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-10">
                <p>IMAGEN IMPRESA: Consiento la publicación de imágenes en el Tablón de anuncios, revistas, orlas, anuario de la Parroquia o del Obispado de Orihuela-Alicante. Como en medios de comunicación externos.</p>
              </div>
              <div class="col-2">
                <div class="form-check form-check-inline">
                  <input id="imagenImpresaSi" name="imagenImpresa" type="radio" class="form-check-input" checked required>
                  <label class="form-check-label" for="imagenImpresaSi">SI</label>
                </div>
                <div class="form-check form-check-inline">
                  <input id="imagenImpresaNo" name="imagenImpresa" type="radio" class="form-check-input" required>
                  <label class="form-check-label" for="imagenImpresaNo">NO</label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-10">
                <p>COMUNICACIONES: Consiento recibir por cualquier medio, incluidos los medios electrónicos, información de la Parroquia como del Obispado de Orihuela-Alicante de actividades, coordinación de grupos de pastoral o eventos religiosos.</p>
              </div>
              <div class="col-2">
                <div class="form-check form-check-inline">
                  <input id="comunicacionesSi" name="comunicaciones" type="radio" class="form-check-input" checked required>
                  <label class="form-check-label" for="comunicacionesSi">SI</label>
                </div>
                <div class="form-check form-check-inline">
                  <input id="comunicacionesNo" name="comunicaciones" type="radio" class="form-check-input" required>
                  <label class="form-check-label" for="comunicacionesNo">NO</label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-10">
                <p>DATOS DE SALUD: Consiento el tratamiento de los datos de salud que serán tratados con la máxima confidencialidad para una correcta coordinación de las actividades, como en comidas o meriendas. En beneficio de los participantes.</p>
              </div>
              <div class="col-2">
                <div class="form-check form-check-inline">
                  <input id="datosSaludSi" name="datosSalud" type="radio" class="form-check-input" checked required>
                  <label class="form-check-label" for="datosSaludSi">SI</label>
                </div>
                <div class="form-check form-check-inline">
                  <input id="datosSaludNo" name="datosSalud" type="radio" class="form-check-input" required>
                  <label class="form-check-label" for="datosSaludNo">NO</label>
                </div>
              </div>
            </div>
          </div>

          <h5>PROTECCIÓN DE DATOS II:</h5>
          <div class="form-check form-check-inline">
            <input type="checkbox" class="form-check-input" id="aceptaTrat" name="aceptaTrat" required>
            <label class="form-check-label" for="aceptaTrat">Acepto el tratamiento de los datos Política de privacidad. Si se produce alguna modificación de sus datos, comuníquenoslo, para mantener sus datos actualizados. El abajo firmante, declara que los datos de contacto son ciertos y que se ha informado y obtenido el consentimiento para el tratamiento de datos por parte de las Parroquias. Para más información sobre tratamiento de los datos lo pueden solicitar a <a href="mailto:inscripcionsanvicenteferrer@gmail.com">inscripcionsanvicenteferrer@gmail.com</a></label>
          </div>

          <hr class="my-4">
          <h5 class="text-center">INFORMACIÓN BÁSICA SOBRE PROTECCIÓN DE DATOS</h5>
          <label><strong>Responsable</strong> PARROQUIA SAN VICENTE FERRER y PARROQUIA INMACULADA CONCEPCIÓN</label>
          <label><strong>DPO</strong> <a href="protecciondedatos@diocesisa.org">protecciondedatos@diocesisa.org</a></label>
          <label><strong>Finalidades</strong> Gestión  y  organización  de  los  grupos  de  pastoral  de  catequesis  de  iniciación  sacramental.  Uso  de  datos  de  salud  para  una  correctacoordinación en las actividades y para gestionar meriendas o comidas. Uso de la imagen. Realización de comunicados para coordinar las actividades a través de cualquier medio, incluido los electrónicos. Envíos informativos de la Parroquia o del Obispado de Orihuela-Alicante para informar de eventos.</label>
          <label><strong>Legitimación</strong> Consentimiento del interesado Padres/Madres o Tutores legales.</label>
          <label><strong>Destinatarios</strong> No se cederán datos a terceros, salvo olbigación legal o dando su consentimiento.</label>
          <label><strong>Derechos</strong> Acceso, rectificación, supresión, oposición y otros desarrollados en información adicional.</label>
          <label><strong>Información adicional</strong> <a href="mailto:inscripcioninmaculada@gmail.com">inscripcioninmaculada@gmail.com</a>  y <a href="inscripcionsanvicenteferrer@gmail.com">inscripcionsanvicenteferrer@gmail.com</a></label>

          <hr class="my-4">
          <button class="w-100 btn btn-primary btn-lg" type="submit" >Enviar la inscripción</button>
        </form>
        </div>
   </div>
  
	 <script>
      // Example POST method implementation:
      async function postData(url = "", data = {}) {
        // Default options are marked with *
        const response = await fetch(url, {
              method: "POST", // *GET, POST, PUT, DELETE, etc.
              mode: "cors", // no-cors, *cors, same-origin
              cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
              credentials: "same-origin", // include, *same-origin, omit
              headers: {
                "Content-Type": "application/json",
                // 'Content-Type': 'application/x-www-form-urlencoded',
              },
              redirect: "follow", // manual, *follow, error
              referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
              body: JSON.stringify(data), // body data type must match "Content-Type" header
        });
        const resp = await response.json(); // parses JSON response into native JavaScript objects
        return { status: response.status, errors: resp['errors'] }; 
      }

      async function getPdf(uuid){
        fetch( `http://127.0.0.1:8080/api/getPdf/${uuid}` )
        .then( res=> res.blob() )
        .then( blob =>{
            const filename = `solicitud.pdf`;
            if (typeof window.navigator.msSaveBlob !== 'undefined') {
                // IE doesn't allow using a blob object directly as link href.
                // Workaround for "HTML7007: One or more blob URLs were
                // revoked by closing the blob for which they were created.
                // These URLs will no longer resolve as the data backing
                // the URL has been freed."
                window.navigator.msSaveBlob(blob, filename);
                return;
            }
            // Other browsers
            // Create a link pointing to the ObjectURL containing the blob
            const blobURL = window.URL.createObjectURL(blob);
            const tempLink = document.createElement('a');
            tempLink.style.display = 'none';
            tempLink.href = blobURL;
            tempLink.setAttribute('download', filename);
            // Safari thinks _blank anchor are pop ups. We only want to set _blank
            // target if the browser does not support the HTML5 download attribute.
            // This allows you to download files in desktop safari if pop up blocking
            // is enabled.
            if (typeof tempLink.download === 'undefined') {
                tempLink.setAttribute('target', '_blank');
            }
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            setTimeout(() => {
                // For Firefox it is necessary to delay revoking the ObjectURL
                window.URL.revokeObjectURL(blobURL);
            }, 100);

        })
        .catch(function(error) {
            console.log('Hubo un problema con la petición Fetch:' + error.message);
        });
      }

			// const span = document.getElementById('coords');
			// const spanC = document.getElementById('coords-calc');

			const serializeForm = ( form ) => {
  			let obj = {}
  			const formData = new FormData( form );
  			for( let key of formData.keys() ) {
	        obj[key]=formData.get(key);
			  }
        // Añadimos las dos imagenes
        obj['firmadoPadre']=document.getElementById('firmadoPadre').src;
        obj['firmadoMadre']=document.getElementById('firmadoMadre').src;
        if( document.getElementById('imagenDigitalNo').checked )
          obj['imagenDigital'] = 'off';
        if( document.getElementById('imagenImpresaNo').checked )
          obj['imagenImpresa'] = 'off';
        if( document.getElementById('comunicacionesNo').checked )
          obj['comunicaciones'] = 'off';
        if( document.getElementById('datosSaludNo').checked )
          obj['datosSalud'] = 'off';
        obj['uuid']=localStorage.getItem("uuid");
  			return obj;
			};

			const mainFormSubmitted =  (event) => {
        event.preventDefault();
   			event.stopPropagation();
  			// console.log( event  );
  			const form = event.target;
  			const serialized = serializeForm(event.target);

        // console.log( serialized);

			  // Validaciones del formulario 
  			// 1º Aceptar protección de datos
  			if( !serialized['aceptaTrat'] ){
    			Swal.fire({icon: 'error',title: 'Debe aceptar la protección de datos'});
    			return;
  			}

  			// 2º Chequear datos requeridos
  			if (!form.checkValidity()) {
    			// event.preventDefault();
    			// event.stopPropagation();
    			let campoErroneo = '';
    			const campos=[ 
    				'nombre',
    				'apellidos',
    				'fechaNacimiento',
    				'colegio',
    				'direccion',
    				'codpost',
    				'email',
    			];
          campos.forEach(element => {
      			if( !serialized[element] ){
        		  Swal.fire({icon: 'error', title: 'Oops...', text: `El campo ${element} es obligatrio`, footer: 'Cumplimentar'});
              erroneos++;
      			}
    			});

          form.classList.add('was-validated');
          if( erroneos >  0 )
            return;
  			}

        // 3º Chequear  progenitores
        if( serialized['firmadoPadre'].length === 0 && serialized['firmadoMadre'].length === 0  ){
        		Swal.fire({icon: 'error', title: 'Oops...', text: 'Al menos uno de los progenitores debe firma la solicitud', footer: 'Cumplimentar'});
            return;
        }

        const nombreMadre = serialized['nombreMadre'];
        const nombrePadre = serialized['nombrePadre'];
        if( (!nombrePadre || nombrePadre.length === 0 ) && 
              (!nombreMadre || nombreMadre.length === 0 ) )
        {
        		Swal.fire({icon: 'error', title: 'Oops...', text: 'Debe consignar el nombre del padre o de la madre', footer: 'Cumplimentar'});
            return;
  			}
        const apellidosPadre = serialized['apellidosPadre'];
        const apellidosMadre = serialized['apellidosMadre'];
        if( (!apellidosPadre || apellidosPadre.length === 0) && 
            (!apellidosMadre || apellidosMadre.length === 0)){
        	  Swal.fire({icon: 'error', title: 'Oops...', text: 'Debe consignar los apellidos del padre o de la madre', footer: 'Cumplimentar'});
            return;
     		}
        const dniPadre = serialized['dniPadre'];
        const dniMadre = serialized['dniMadre'];
        if( (!dniPadre || dniPadre.length === 0) && 
            (!dniMadre || dniMadre.length === 0)){
            Swal.fire({icon: 'error', title: 'Oops...', text: 'Debe consignar el DNI del padre o de la madre', footer: 'Cumplimentar'});
            return;
     		}
        const telefonoPadre = serialized['telefonoPadre'];
        const telefonoMadre = serialized['telefonoMadre'];
        if( (!telefonoPadre || telefonoPadre.length === 0) && 
             (!telefonoMadre || telefonoMadre.length === 0)){
        	  Swal.fire({icon: 'error', title: 'Oops...', text: 'Debe consignar el teléfono del padre o de la madre', footer: 'Cumplimentar'});
            return;
     		}

        // Postear los datos
  			postData("http://127.0.0.1:8080/api/post-solicitud", serialized).then((data) => {
          if( data.status >= 400 ){
            Swal.fire({icon: 'error', title: 'Oops...', text: data.errors[0].msg, footer: 'Cumplimentar'});
          } else {
            Swal.fire({
              title: `¿Quieres descargar el fichero ${serialized.uuid}.PDF generado?`,
              showDenyButton: true,
              showCancelButton: false,
              confirmButtonText: 'Si',
              denyButtonText: 'No',
            }).then((result) => {
              if (result.isConfirmed) {
                getPdf(serialized.uuid);
                Swal.fire('Descargado!', '', 'success')
              }
               window.location = "https://www.parroquiasdesanvicente.es/";
            });
          }
        }).catch( (err) => {
          // Swal.fire({icon: 'error', title: 'Oops...', text: `El campo ${element} es obligatrio`, footer: 'Cumplimentar'});
          console.error( err );
        });

  			// const json = JSON.stringify( serialized );
				// window.location.href = "upload_form.php?solicitud=" + btoa(json); 
			};

			const logSubmit = (event) => {
  			console.log( `Form Submitted! Timestamp: ${event.timeStamp}` );
  			event.preventDefault();
			};

			const form = document.getElementById("main-form");
			form.addEventListener("submit", mainFormSubmitted);

			const resetCanvas = () => {
  			const canvas = document.getElementById('canvas');
  			canvas.width_line = 1;
  			canvas.color = "#000000";
				canvas.sign = false;
  			canvas.begin_sign = false;
  			canvas.cursorX = 0;
  			canvas.cursorY = 0;
  			const context = canvas.getContext('2d');
  			context.clearRect(0, 0, canvas.width, canvas.height);
			};

			document.getElementById("reset").addEventListener("click", (event) => {
  			resetCanvas();
			});

			// Target => canvas

      // isCanvasBlank - returns true if every pixel's uint32 representation is 0 (or "blank")
      const  isCanvasBlank = (canvas) => {
        const context = canvas.getContext('2d');
          const pixelBuffer = new Uint32Array(
            context.getImageData(0, 0, canvas.width, canvas.height).data.buffer );
        return !pixelBuffer.some(color => color !== 0);
      }

			const updateMousePosition = (target, mX, mY) => {
     		const rect = target.getBoundingClientRect();
    		const scaleX = target.width / rect.width;
    		const scaleY = target.height / rect.height;
    		target.cursorX = Math.floor( ((mX - rect.left)*scaleX)*100)/100;
    		target.cursorY = Math.floor( ((mY - rect.top)*scaleY)*100)/100;
  		}

			// Target => canvas
			const  createSignature = (target) => {
    		if( target ){
      		const context = target.getContext('2d');
      		// console.log( 'context', context );
      		if( context ){
        		if (!target.begin_sign) {
          		context.beginPath();
          		context.moveTo(target.cursorX, target.cursorY);
          		target.begin_sign = true;
        		} else {
          		context.lineTo(target.cursorX, target.cursorY);
          		context.strokeStyle = target.color;
          		context.lineWidth = target.width_line;
          		context.stroke();
        		}
      		}
    		}
			};

			const onMouseDown = ({ target, pageX, pageY, changedTouches }) => {
  			target.sign = true;
  			// span.innerText = `md   x: ${ target.cursorX} y; ${target.cursorY}`;
        // console.log( 'changedTouches', changedTouches );
        if( changedTouches && changedTouches[0]){
          updateMousePosition(target, changedTouches[0].pageX, changedTouches[0].pageY);
        } else {
          updateMousePosition(target, pageX, pageY);
        }
			};

			const onMouseUp = ({target}) => {
  			target.sign = false;
  			target.begin_sign = false;
			};

			const onMouseMove = ({ target, pageX, pageY, changedTouches }) => {
        if( changedTouches && changedTouches[0]){
    			// span.innerText = `mm   x: ${ changedTouches[0].pageX } y; ${ changedTouches[0].pageY }`;
    			updateMousePosition(target, changedTouches[0].pageX, changedTouches[0].pageY);
        } else {
    			// span.innerText = `mm   x: ${ pageX} y; ${pageY}`;
    			updateMousePosition(target, pageX, pageY);
          // spanC.innerText = `sign: ${ target.sign } begin_sign: ${target.begin_sign}  x: ${ target.cursorX} y; ${target.cursorY}`;
        }
  			if (target.sign) {
    			createSignature(target);
  			}
			};
  
			const  modalEvents = ()=> {
    		$("#bookingmodal").on("hidden.bs.modal", function () {
      	// Quitar eventos

      	const canvas = document.getElementById('canvas');
      	  canvas.removeEventListener("mousedown", onMouseDown, false );
      	  canvas.removeEventListener("mouseup", onMouseUp, false );
      	  canvas.removeEventListener('mousemove', onMouseMove, false );
          canvas.addEventListener("touchstart", onMouseDown, false );
          canvas.addEventListener("touchend", onMouseUp, false );
          canvas.addEventListener('touchmove', onMouseMove, false );

      	let i = document.getElementById('firmadoPadre');
        const progenitor = this['progenitor'];
      	if(  progenitor === 'Madre'){
        	i = document.getElementById('firmadoMadre');
      	}
        if( isCanvasBlank(canvas)){
          i.removeAttribute('src');
        }
        else {
      	  i.src = canvas.toDataURL();
      	  resetCanvas();
        }
      	canvas.sign = false;
      	canvas.begin_sign = false;
      	canvas.cursorX = 0;
      	canvas.cursorY = 0;
    	});

    $("#bookingmodal").on("show.bs.modal", function (event) {
      // Esto es una "ñapa" para que funcione el firmado 
        window.scroll(0,0);

        const canvas = document.getElementById('canvas');
        canvas.width_line = 1;
        canvas.color = "#000000";
        canvas.sign = false;
        canvas.begin_sign = false;
        canvas.cursorX = 0;
        canvas.cursorY = 0;
        const context = canvas.getContext('2d');
      
        const button = event.relatedTarget;
        let i = document.getElementById('firmadoPadre');
        // En el button hay que añadir un attr. data-bs-p con valor Padre o Madre
        // Para saber que imagen hya que actualziar o de la que hay que dibujar en canvas 
        const progenitor = button.getAttribute('data-bs-p');
        this['progenitor']=progenitor;
        if(  progenitor === 'Madre'){
          i = document.getElementById('firmadoMadre');
        }
        if( i.src ){
          context.drawImage(i, 0, 0);
        }
        // Se establecen los eventos 
          canvas.addEventListener("mousedown", onMouseDown, false );
          canvas.addEventListener("mouseup", onMouseUp, false );
          canvas.addEventListener('mousemove', onMouseMove, false );
          canvas.addEventListener("touchstart", onMouseDown, false );
          canvas.addEventListener("touchend", onMouseUp, false );
          canvas.addEventListener('touchmove', onMouseMove, false );
      });
		}

      const firmaConCertificado = (quien) => {
        fetch( `https://www.uuid.alopeze.com:8433/api/get-QRCert` )
          .then( res => res.text() )
          .then( data =>{  
            let ocultar;
            let img;
            if( quien === 'Padre'){
              ocultar = document.getElementById('certificadoMadre');
              img = document.getElementById('firmadoPadre');
            } 
            else {
              ocultar = document.getElementById('certificadoPadre');
              img = document.getElementById('firmadoMadre');
            }
            ocultar.setAttribute("hidden", "hidden");
            img.src = data;
          });
      }

			// Lanza todos los event 
		modalEvents();

	 </script>	

  </body>
</html>
